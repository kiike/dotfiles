#!/usr/bin/env lua
-- mocp notifier for Awesome WM

local function mocp_parse(mocp_info)
	-- Sanitize input
	mocp_info = mocp_info:gsub("&", "&amp;")

	local state = string.match(mocp_info, "State: (%w+)")
	if state == "STOP" then
		local widget_cmd = "now_playing_widget:set_text('')"
		local notify_cmd = nil
		return widget_cmd, notify_cmd

	else
		local artist = mocp_info:match("Artist: (%C+)")
		local album = mocp_info:match("Album: (%C+)")
		local title = mocp_info:match("SongTitle: (%C+)")
		local totaltime = mocp_info:match("TotalTime: (%C+)")

		local notify_template = "%s (%s)\nby %s\non %s"
		local notify_text = notify_template:format(title, totaltime, artist, album)
		notify_text = notify_text:gsub("'", "\\'")
		local notify_cmd = string.format("notify-send 'Now playing' '%s'", notify_text)

		local widget_template = "<span font='Noto Emoji'>&#9654;</span> <span color='#b16286'>%s</span> by <span color='#689d6a'>%s</span>"
		local widget_markup = widget_template:format(title, artist)
		local widget_cmd = string.format('now_playing_widget:set_markup("%s")', widget_markup)

		return widget_cmd, notify_cmd
	end

end

local mocp_handle = io.popen("mocp -i")
local mocp_info = mocp_handle:read("*a")

local widget_cmd, notify_cmd = mocp_parse(mocp_info)

if widget_cmd then
	local awesome_client = io.popen("awesome-client", "w")
	awesome_client:write(widget_cmd)
end

if notify_cmd then
	io.popen(notify_cmd)
end
